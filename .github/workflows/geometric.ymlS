name: Geometric Intelligence Proof Run

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly proof run

jobs:
  geometric-proof:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: '1.9'
        
    - name: Cache Julia packages
      uses: actions/cache@v3
      env:
        cache-name: cache-julia-packages
      with:
        path: ~/.julia
        key: ${{ runner.os }}-test-${{ env.cache-name }}-${{ hashFiles('**/Project.toml') }}
        restore-keys: |
          ${{ runner.os }}-test-${{ env.cache-name }}-
          ${{ runner.os }}-test-
          ${{ runner.os }}-
          
    - name: Install dependencies
      run: |
        julia -e 'using Pkg; Pkg.add(["JSON3", "Statistics", "LinearAlgebra", "Random", "Dates"])'
        
    - name: Run Geometric Proof Suite
      run: julia proof_suite.jl
      
    - name: Upload Proof Results
      uses: actions/upload-artifact@v4
      with:
        name: geometric-proof-results
        path: |
          proof_results.json
          proof_summary.txt
        retention-days: 30
        
    - name: Cleanup build files
      run: |
        echo "ğŸ§¹ Cleaning up build files..."
        # Remove Julia compilation cache
        rm -rf ~/.julia/compiled/v1.9/*
        # Remove any temporary files
        find . -name "*.ji" -delete
        find . -name "*.so" -delete
        find . -name "*.dylib" -delete
        find . -name "*.dll" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete
        # Remove any large cache directories
        rm -rf .julia .cache __pycache__
        echo "âœ… Build files cleaned up"
        
    - name: Verify cleanup
      run: |
        echo "ğŸ“ Remaining files:"
        find . -type f -name "*.json" -o -name "*.txt" -o -name "*.jl" -o -name "*.toml" -o -name "*.yml" | sort
        echo "ğŸ’¾ Disk usage after cleanup:"
        du -sh . || true
